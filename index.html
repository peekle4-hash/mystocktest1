<!DOCTYPE html>

<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width,initial-scale=1" name="viewport"/>
  <title>주식 매매기록 · 수익률 대시보드</title>
  <link href="./styles.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <div class="header-top">
    <div>
      <h1>주식 매매기록 · 수익률 대시보드</h1>
      <p class="sub">매수/매도 기록 · 실현/평가 손익 · ISA/일반 분리 · 날짜별 접기/펼치기 · CSV 백업</p>
    </div>
  </div>

  <!-- 탭 네비게이션 -->
  <nav class="tabs" aria-label="페이지 탭">
    <button class="tab-btn active" data-tab="tab-dashboard" type="button">대시보드</button>
    <button class="tab-btn" data-tab="tab-close" type="button">기준일 종가</button>
    <button class="tab-btn" data-tab="tab-trades" type="button">매매기록</button>
    <button class="tab-btn" data-tab="tab-monthly" type="button">월별 수익률</button>
    <button class="tab-btn" data-tab="tab-sync" type="button">구글시트 연동</button>
    <button class="tab-btn" data-tab="tab-format" type="button">도움말</button>
  </nav>
</header>

<main>
  <!-- 1) 대시보드 -->
  <section class="card tab-page active" id="tab-dashboard">
    <div class="row">
      <div>
        <label for="asOfDate"><b>기준 날짜</b></label>
        <input id="asOfDate" type="date"/>
      </div>
      <div class="grow"></div>
      <div class="hint">기준 날짜의 종가(평가가)를 입력하면 평가손익/수익률이 계산돼요.</div>
    </div>

<!-- 전체 KPI 5개 -->
<div class="kpi-grid">
  <div class="kpi kpi-all">
    <div class="kpi-title">보유 원가(전체)</div>
    <div class="kpi-val" id="kpiCostAll">-</div>
  </div>
  <div class="kpi kpi-all">
    <div class="kpi-title">평가손익(전체)</div>
    <div class="kpi-val" id="kpiUnrealAll">-</div>
  </div>
  <div class="kpi kpi-all">
    <div class="kpi-title">실현손익 누적(전체)</div>
    <div class="kpi-val" id="kpiRealAll">-</div>
  </div>
  <div class="kpi kpi-all">
    <div class="kpi-title">총 손익(전체)</div>
    <div class="kpi-val" id="kpiTotalAll">-</div>
  </div>
  <div class="kpi kpi-all">
    <div class="kpi-title">총 수익률(전체)</div>
    <div class="kpi-val" id="kpiRetAll">-</div>
  </div>
</div>

<!-- ISA KPI 4개 -->
<div class="kpi-grid-3">
  <div class="kpi kpi-isa">
    <div class="kpi-title">보유 원가(ISA)</div>
    <div class="kpi-val" id="kpiCostISA">-</div>
  </div>
  <div class="kpi kpi-isa">
    <div class="kpi-title">평가손익(ISA)</div>
    <div class="kpi-val" id="kpiUnrealISA">-</div>
  </div>
  <div class="kpi kpi-isa">
    <div class="kpi-title">실현손익 누적(ISA)</div>
    <div class="kpi-val" id="kpiRealISA">-</div>
  </div>
  <div class="kpi kpi-isa">
    <div class="kpi-title">총 수익률(ISA)</div>
    <div class="kpi-val" id="kpiRetISA">-</div>
  </div>
</div>

<!-- 일반 KPI 4개 -->
<div class="kpi-grid-3">
  <div class="kpi kpi-gen">
    <div class="kpi-title">보유 원가(일반)</div>
    <div class="kpi-val" id="kpiCostGEN">-</div>
  </div>
  <div class="kpi kpi-gen">
    <div class="kpi-title">평가손익(일반)</div>
    <div class="kpi-val" id="kpiUnrealGEN">-</div>
  </div>
  <div class="kpi kpi-gen">
    <div class="kpi-title">실현손익 누적(일반)</div>
    <div class="kpi-val" id="kpiRealGEN">-</div>
  </div>
  <div class="kpi kpi-gen">
    <div class="kpi-title">총 수익률(일반)</div>
    <div class="kpi-val" id="kpiRetGEN">-</div>
  </div>
</div>

    <div class="note">※ 계산 방식: <b>이동평균(평균단가)</b> 기준. 공매도/마이너스 보유수량은 지원 안 해요.</div>
  </section>

  <!-- 2) 기준일 종가 입력 -->
  <section class="card tab-page" id="tab-close">
    <div class="row">
      <h2>기준일 종가 입력</h2>
      <div class="grow"></div>
      <div class="hint">기준 날짜에 대해 종가를 기업별로 한 번만 입력하면 평가손익이 자동 계산돼요. (미입력은 -)</div>
    </div>

    <div class="row">
      <div class="bulk-box">
        <label for="bulkClose"><b>일괄 입력</b> (한 줄에 하나: <code>기업명, 종가</code> 또는 <code>기업명 종가</code>)</label>
        <textarea id="bulkClose" placeholder="예)
삼성전자, 71500
TIGER 미국S&amp;P500 25120" rows="4"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="applyBulkCloseBtn">일괄 적용</button>
          <button class="secondary" id="clearCloseBtn">이 기준일 종가 전체 지우기</button>
        </div>
      </div>
    </div>

    <div class="table-wrap mini">
      <table id="closeTable">
        <thead>
          <tr>
            <th>기업명</th>
            <th>종가</th>
            <th>기준일</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 3) 데이터 입력(매매기록) -->
  <section class="card tab-page" id="tab-trades">
    <div class="row">
      <h2>데이터 입력 (매매기록)</h2>
      <div class="grow"></div>
      <div class="btns">
        <button id="addRowBtn">행 추가</button>
        <button class="secondary" id="exportBtn">CSV 내보내기</button>
        <label class="file secondary">
          CSV 가져오기
          <input accept=".csv" id="importFile" type="file"/>
        </label>
        <button class="danger" id="clearBtn">전체 삭제</button>
      </div>
      <div class="hint">입력: 날짜 / 기업명 / 계좌 / 매수·매도 / 단가 / 수량</div>
    </div>

    <div class="row summary-row">
      <h3 class="h3">보유현황(기업별)</h3>
      <div class="grow"></div>
      <div class="seg">
        <button class="seg-btn active" id="holdScopeAll" type="button">전체</button>
        <button class="seg-btn" id="holdScopeISA" type="button">ISA</button>
        <button class="seg-btn" id="holdScopeGEN" type="button">일반</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <h3 class="h3" style="font-size:16px;margin:0">현재 보유중</h3>
    </div>

    <div class="table-wrap mini">
      <table id="holdTableCurrent">
        <thead>
          <tr>
            <th>기업명</th>
            <th>계좌</th>
            <th>보유수량</th>
            <th>평균단가</th>
            <th>보유원가</th>
            <th>종가</th>
            <th>평가손익</th>
            <th>실현손익 누적</th>
            <th>총 손익</th>
            <th>총 수익률</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:18px">
      <h3 class="h3" style="font-size:16px;margin:0">매도 완료 종목</h3>
      <div class="grow"></div>
      <div class="hint">보유수량이 0이 된 종목은 여기에 자동으로 모여요. 다시 매수하면 ‘현재 보유중’으로 돌아가요.</div>
    </div>

    <div class="table-wrap mini">
      <table id="holdTableClosed">
        <thead>
          <tr>
            <th>기업명</th>
            <th>계좌</th>
            <th>보유수량</th>
            <th>평균단가</th>
            <th>보유원가</th>
            <th>종가</th>
            <th>평가손익</th>
            <th>실현손익 누적</th>
            <th>총 손익</th>
            <th>총 수익률</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-wrap data-entry">
      <table id="dataTable">
        <thead>
          <tr>
            <th>날짜</th>
            <th>기업명</th>
            <th>계좌</th>
            <th>구분</th>
            <th>단가</th>
            <th>수량</th>
            <th>거래금액</th>
            <th>실현손익(이 거래)</th>
            <th>누적 실현손익</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 4) 월별 수익률 -->
  <section class="card tab-page" id="tab-monthly">
    <div class="row">
      <h2>월별 수익률</h2>
      <div class="grow"></div>
      <div class="hint">월별 투자금액/손익/수익률(월말 종가 기준)</div>
    </div>

    <div class="table-wrap">
      <table id="monthlyTable">
        <thead>
          <tr>
            <th>연-월</th>
            <th>ISA 투자금액</th>
            <th>ISA 손익</th>
            <th>ISA 수익률</th>
            <th>일반 투자금액</th>
            <th>일반 손익</th>
            <th>일반 수익률</th>
            <th>전체 투자금액</th>
            <th>전체 손익</th>
            <th>전체 수익률</th>
            <th>ISA 누적</th>
            <th>일반 누적</th>
            <th>전체 누적</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="charts">
      <div class="chart">
        <canvas id="barMonthly"></canvas>
      </div>
      <div class="chart">
        <canvas id="lineCumulative"></canvas>
      </div>
    </div>
  </section>

  <!-- 5) 구글시트 연동(클라우드) -->
  <section class="card tab-page" id="tab-sync">
    <div class="row">
      <h2>구글 스프레드시트 연동</h2>
      <div class="grow"></div>
      <div class="hint">PC/모바일 어디서 접속해도 데이터가 유지되게 “클라우드 저장소(구글시트)”로 동기화해요.</div>
    </div>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label for="gsUrl"><b>Apps Script 배포 URL</b> (웹 앱 /exec)</label>
        <input id="gsUrl" type="text" placeholder="예) https://script.google.com/macros/s/XXXX/exec" />
      </div>
      <div>
        <label for="gsToken"><b>보안 토큰</b> (내가 정한 비밀번호)</label>
        <input id="gsToken" type="text" placeholder="예) my-secret" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <label class="switch">
        <input id="gsAuto" type="checkbox" />
        <span>변경 시 자동 업로드(권장)</span>
      </label>
      <div class="grow"></div>
      <div class="btns">
        <button class="secondary" id="gsLoadBtn" type="button">클라우드에서 불러오기</button>
        <button id="gsSaveBtn" type="button">클라우드에 저장(업로드)</button>
      </div>
    </div>

    <div class="note" id="gsStatus">상태: -</div>

    <div class="row" style="margin-top:10px">
      <div class="hint">백업: 혹시 모를 상황을 대비해 데이터 전체를 파일로 저장/복원할 수 있어요.</div>
      <div class="grow"></div>
      <div class="btns">
        <button class="secondary" id="gsBackupBtn" type="button">백업 다운로드(JSON)</button>
        <label class="btn-like" for="gsRestoreFile">백업으로 복원</label>
        <input id="gsRestoreFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>


    <details style="margin-top:8px">
      <summary>설정 방법(처음 한 번만)</summary>
      <ol class="ol">
        <li>구글 드라이브 → 새로 만들기 → <b>Google Apps Script</b></li>
        <li>내가 준 <b>Apps Script 코드</b>를 붙여넣고 저장</li>
        <li><b>배포</b> → <b>새 배포</b> → 유형: <b>웹 앱</b></li>
        <li>실행 사용자: <b>나</b> / 접근 권한: <b>모든 사용자</b> (또는 링크가 있는 모든 사용자)</li>
        <li>배포 URL(/exec)을 위 칸에 붙여넣고, 토큰도 동일하게 입력</li>
      </ol>
      <p class="note">※ 토큰은 URL에 노출되지 않게, 앱에서만 보내요. (그래도 <b>아무거나</b> 말고 길게 설정 추천)</p>
    </details>
  </section>

  <section class="card small tab-page" id="tab-format">
    <details>
      <summary>CSV 형식</summary>
      <p>헤더: <code>date,company,account,side,price,qty,close</code></p>
      <p><code>side</code>는 <b>BUY</b> 또는 <b>SELL</b> (또는 매수/매도) 가능.</p>
    </details>
  </section>
</main>

<footer>
  <span>데이터는 브라우저(LocalStorage)에 저장돼요. 다른 기기로 옮기려면 CSV 내보내기/가져오기.</span>
</footer>

<script src="./app.js"></script>
</body>
</html>
